name: Dev Branch Build

on:
  push:
    branches:
      - dev

jobs:
  build-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          # Get current version from Version.cs
          CURRENT_VERSION=$(grep 'AppVersion =' src/Version.cs | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Add build number and dev suffix
          BUILD_NUMBER=${{ github.run_number }}
          DEV_VERSION="$CURRENT_VERSION.$BUILD_NUMBER-dev"

          echo "Dev version: $DEV_VERSION"
          echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Copy Frontend to wwwroot
        run: |
          rm -rf src/wwwroot/assets src/wwwroot/index.html
          mkdir -p src/wwwroot/assets
          cp -r _output/UI/* src/wwwroot/
          echo "Frontend files copied to src/wwwroot:"
          ls -la src/wwwroot/

      - name: Build Windows x64
        run: |
          dotnet publish src/Sportarr.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:SkipFrontendBuild=true -p:Version=${{ steps.version.outputs.version }} -o publish/win-x64
          cd publish/win-x64 && zip -r ../../Sportarr-win-x64-${{ steps.version.outputs.version }}.zip .

      - name: Build Linux x64
        run: |
          dotnet publish src/Sportarr.csproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -p:SkipFrontendBuild=true -p:Version=${{ steps.version.outputs.version }} -o publish/linux-x64
          cd publish/linux-x64 && tar -czvf ../../Sportarr-linux-x64-${{ steps.version.outputs.version }}.tar.gz .

      - name: Build Linux ARM64
        run: |
          dotnet publish src/Sportarr.csproj -c Release -r linux-arm64 --self-contained true -p:PublishSingleFile=true -p:SkipFrontendBuild=true -p:Version=${{ steps.version.outputs.version }} -o publish/linux-arm64
          cd publish/linux-arm64 && tar -czvf ../../Sportarr-linux-arm64-${{ steps.version.outputs.version }}.tar.gz .

      - name: Build macOS x64
        run: |
          dotnet publish src/Sportarr.csproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -p:SkipFrontendBuild=true -p:Version=${{ steps.version.outputs.version }} -o publish/osx-x64
          cd publish/osx-x64 && tar -czvf ../../Sportarr-osx-x64-${{ steps.version.outputs.version }}.tar.gz .

      - name: Build macOS ARM64 (Apple Silicon)
        run: |
          dotnet publish src/Sportarr.csproj -c Release -r osx-arm64 --self-contained true -p:PublishSingleFile=true -p:SkipFrontendBuild=true -p:Version=${{ steps.version.outputs.version }} -o publish/osx-arm64
          cd publish/osx-arm64 && tar -czvf ../../Sportarr-osx-arm64-${{ steps.version.outputs.version }}.tar.gz .

      - name: Update dev prerelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dev
          name: Development Build
          body: |
            ## Development Build - ${{ steps.version.outputs.version }}

            ⚠️ **This is a development build for testing purposes.**

            This release is automatically updated with each push to the dev branch.

            ### Docker
            ```
            docker pull sportarr/sportarr:dev
            ```

            ### Downloads
            - **Windows x64**: Sportarr-win-x64-${{ steps.version.outputs.version }}.zip
            - **Linux x64**: Sportarr-linux-x64-${{ steps.version.outputs.version }}.tar.gz
            - **Linux ARM64**: Sportarr-linux-arm64-${{ steps.version.outputs.version }}.tar.gz
            - **macOS x64**: Sportarr-osx-x64-${{ steps.version.outputs.version }}.tar.gz
            - **macOS ARM64**: Sportarr-osx-arm64-${{ steps.version.outputs.version }}.tar.gz
          draft: false
          prerelease: true
          files: |
            Sportarr-win-x64-${{ steps.version.outputs.version }}.zip
            Sportarr-linux-x64-${{ steps.version.outputs.version }}.tar.gz
            Sportarr-linux-arm64-${{ steps.version.outputs.version }}.tar.gz
            Sportarr-osx-x64-${{ steps.version.outputs.version }}.tar.gz
            Sportarr-osx-arm64-${{ steps.version.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            sportarr/sportarr:dev
            sportarr/sportarr:${{ steps.version.outputs.version }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
        env:
          BUILDX_NO_DEFAULT_ATTESTATIONS: 1

      - name: Send Discord notification
        if: success()
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_RELEASE_WEBHOOK }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Get the commit that triggered this build
          COMMIT_MSG=$(git log --pretty=format:"%s" -1 | sed 's/"/\\"/g')
          COMMIT_SHA=$(git rev-parse --short HEAD)

          DESCRIPTION="**Development Build**\n• ${COMMIT_MSG}\n\n⚠️ **This is a development build for testing purposes.**\n\n**Docker Installation**\n\`\`\`\ndocker pull sportarr/sportarr:dev\n\`\`\`\n\n**Downloads**\n[View all platform downloads](https://github.com/${{ github.repository }}/releases/tag/dev)"

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"Sportarr Dev\",
              \"embeds\": [{
                \"title\": \"Dev Build - ${VERSION}\",
                \"description\": \"$DESCRIPTION\",
                \"color\": 16776960,
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }"
